<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crack the Code (2 Player Room)</title>

<style>
  /* =========================================================
     MODE (Light/Dark) is separate from THEME (background style)
     "Themes" = patterns/images + accent palette (Instagram-like)
     ========================================================= */

  :root{
    /* Mode tokens */
    --bg:#ffffff;
    --card:#ffffff;
    --panel:#f8fafc;
    --ink:#0f172a;
    --muted:#64748b;
    --line:#e2e8f0;
    --line2:#cbd5e1;

    /* Theme tokens */
    --accent:#2563eb;
    --accent2:#7c3aed;
    --accentText:#ffffff;

    --shadow:0 12px 34px rgba(2,6,23,.10);

    /* Theme visuals */
    --bgImg:none;
    --innerImg: none;
    --innerOverlay: linear-gradient(180deg, rgba(255,255,255,.70), rgba(255,255,255,.70));
    --bgOverlay: linear-gradient(180deg, rgba(255,255,255,.78), rgba(255,255,255,.78));
    --cardTint: rgba(255,255,255,.92);
    --panelTint: rgba(248,250,252,.92);
  }

  [data-mode="dark"]{
    --bg:#0b1220;
    --card:#0f172a;
    --panel:#0b1327;
    --ink:#e5e7eb;
    --muted:#94a3b8;
    --line:#22314a;
    --line2:#334155;

    --accentText:#07101f;

    --shadow:0 18px 42px rgba(0,0,0,.42);

    --bgOverlay: linear-gradient(180deg, rgba(5,10,20,.72), rgba(5,10,20,.72));
    --innerOverlay: linear-gradient(180deg, rgba(5,10,20,.55), rgba(5,10,20,.55));
    --innerImg: none;
    --cardTint: rgba(15,23,42,.88);
    --panelTint: rgba(11,19,39,.88);
  }

  /* =========================
     Themes (patterns/images)
     ========================= */

  /* Soft: Blush */
  [data-theme="blush"]{
    --bgImg: url("data:image/svg+xml;utf8,\
    --innerImg: radial-gradient(circle at 20% 20%, rgba(236,72,153,.16), transparent 45%), radial-gradient(circle at 80% 30%, rgba(168,85,247,.12), transparent 50%), repeating-linear-gradient(135deg, rgba(236,72,153,.08) 0 12px, rgba(255,255,255,0) 12px 28px);utf8,<svg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220'><rect width='220' height='220' fill='none'/><g fill='%23fb7185' fill-opacity='0.10'><circle cx='40' cy='40' r='10'/><circle cx='180' cy='70' r='8'/><circle cx='120' cy='170' r='9'/><circle cx='70' cy='140' r='6'/></g><g stroke='%23fda4af' stroke-opacity='0.20' stroke-width='3'><path d='M20 200 C60 150 90 150 130 200'/><path d='M90 70 C120 30 150 30 180 70'/></g></svg>");
<svg xmlns='http://www.w3.org/2000/svg' width='260' height='260' viewBox='0 0 260 260'>\
<rect width='260' height='260' fill='%23fff1f2'/>\
<g fill='%23fda4af' fill-opacity='0.35'>\
<path d='M64 70c-10-10-26-10-36 0-10 10-10 26 0 36l36 36 36-36c10-10 10-26 0-36-10-10-26-10-36 0z'/>\
<path d='M190 170c-9-9-23-9-32 0-9 9-9 23 0 32l32 32 32-32c9-9 9-23 0-32-9-9-23-9-32 0z'/>\
</g>\
<g fill='%23fb7185' fill-opacity='0.18'>\
<circle cx='185' cy='78' r='10'/><circle cx='78' cy='198' r='12'/>\
</g>\
</svg>");
    --accent:#ec4899;
    --accent2:#a855f7;
  }

  /* Soft: Lavender */
  [data-theme="lavender"]{
    --bgImg: url("data:image/svg+xml;utf8,\
    --innerImg: radial-gradient(circle at 25% 30%, rgba(124,58,237,.14), transparent 48%), radial-gradient(circle at 80% 70%, rgba(37,99,235,.10), transparent 52%), repeating-linear-gradient(0deg, rgba(167,139,250,.08) 0 10px, rgba(255,255,255,0) 10px 22px);utf8,<svg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'><rect width='240' height='240' fill='none'/><g stroke='%23c4b5fd' stroke-opacity='0.25' stroke-width='3'><path d='M30 40h24M42 28v24'/><path d='M190 60h24M202 48v24'/><path d='M70 200h24M82 188v24'/></g><g fill='%23a78bfa' fill-opacity='0.10'><circle cx='140' cy='140' r='46'/></g></svg>");
<svg xmlns='http://www.w3.org/2000/svg' width='280' height='280' viewBox='0 0 280 280'>\
<rect width='280' height='280' fill='%23faf5ff'/>\
<g stroke='%23c4b5fd' stroke-width='3' stroke-opacity='0.35'>\
<path d='M56 48l0 24M44 60l24 0'/>\
<path d='M220 78l0 24M208 90l24 0'/>\
<path d='M170 220l0 24M158 232l24 0'/>\
</g>\
<g fill='%23a78bfa' fill-opacity='0.15'>\
<circle cx='132' cy='132' r='60'/>\
</g>\
</svg>");
    --accent:#7c3aed;
    --accent2:#2563eb;
  }

  /* Soft: Sky */
  [data-theme="sky"]{
    --bgImg: url("data:image/svg+xml;utf8,\
    --innerImg: radial-gradient(circle at 25% 25%, rgba(6,182,212,.14), transparent 45%), radial-gradient(circle at 75% 60%, rgba(59,130,246,.12), transparent 50%), repeating-linear-gradient(135deg, rgba(6,182,212,.07) 0 14px, rgba(255,255,255,0) 14px 32px);utf8,<svg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'><rect width='240' height='240' fill='none'/><g fill='%2367e8f9' fill-opacity='0.14'><circle cx='60' cy='70' r='18'/><circle cx='85' cy='70' r='14'/><circle cx='72' cy='55' r='10'/><circle cx='165' cy='160' r='16'/><circle cx='188' cy='160' r='12'/><circle cx='176' cy='148' r='9'/></g><g stroke='%2306b6d4' stroke-opacity='0.18' stroke-width='3'><path d='M20 210 Q60 180 100 210 T180 210'/></g></svg>");
<svg xmlns='http://www.w3.org/2000/svg' width='280' height='280' viewBox='0 0 280 280'>\
<rect width='280' height='280' fill='%23ecfeff'/>\
<g fill='%2367e8f9' fill-opacity='0.25'>\
<circle cx='78' cy='78' r='22'/><circle cx='108' cy='78' r='18'/><circle cx='94' cy='62' r='14'/>\
<circle cx='205' cy='165' r='20'/><circle cx='233' cy='165' r='16'/><circle cx='219' cy='149' r='12'/>\
</g>\
<g fill='%2306b6d4' fill-opacity='0.12'>\
<circle cx='142' cy='240' r='42'/>\
</g>\
</svg>");
    --accent:#06b6d4;
    --accent2:#3b82f6;
  }

  /* Cool: Neon Lines */
  [data-theme="neon"]{
    --bgImg: url("data:image/svg+xml;utf8,\
    --innerImg: radial-gradient(circle at 20% 25%, rgba(34,211,238,.12), transparent 46%), radial-gradient(circle at 85% 70%, rgba(167,139,250,.10), transparent 52%), repeating-linear-gradient(115deg, rgba(34,211,238,.10) 0 8px, rgba(255,255,255,0) 8px 22px);utf8,<svg xmlns='http://www.w3.org/2000/svg' width='260' height='260' viewBox='0 0 260 260'><rect width='260' height='260' fill='none'/><g stroke='%2322d3ee' stroke-opacity='0.20' stroke-width='3'><path d='M-10 60 L270 20'/><path d='M-10 140 L270 100'/><path d='M-10 220 L270 180'/></g><g stroke='%23a78bfa' stroke-opacity='0.16' stroke-width='2'><path d='M-10 30 L270 70'/><path d='M-10 110 L270 150'/></g></svg>");
<svg xmlns='http://www.w3.org/2000/svg' width='300' height='300' viewBox='0 0 300 300'>\
<rect width='300' height='300' fill='%230b1220'/>\
<g stroke='%2322d3ee' stroke-opacity='0.35' stroke-width='3'>\
<path d='M-30 55 L330 10'/><path d='M-30 130 L330 85'/><path d='M-30 205 L330 160'/><path d='M-30 280 L330 235'/>\
</g>\
<g stroke='%23a78bfa' stroke-opacity='0.25' stroke-width='2'>\
<path d='M-20 20 L320 70'/><path d='M-20 95 L320 145'/><path d='M-20 170 L320 220'/>\
</g>\
</svg>");
    --accent:#22d3ee;
    --accent2:#a78bfa;
  }

  /* Cool: Racer (checkered + stripe) */
  [data-theme="racer"]{
    --bgImg: url("data:image/svg+xml;utf8,\
    --innerImg: repeating-linear-gradient(90deg, rgba(15,23,42,.05) 0 16px, rgba(255,255,255,0) 16px 32px), repeating-linear-gradient(0deg, rgba(15,23,42,.04) 0 16px, rgba(255,255,255,0) 16px 32px), linear-gradient(135deg, rgba(239,68,68,.10), transparent 55%);utf8,<svg xmlns='http://www.w3.org/2000/svg' width='220' height='220' viewBox='0 0 220 220'><rect width='220' height='220' fill='none'/><g fill='%230f172a' fill-opacity='0.05'><rect x='0' y='0' width='22' height='22'/><rect x='44' y='0' width='22' height='22'/><rect x='88' y='0' width='22' height='22'/><rect x='132' y='0' width='22' height='22'/><rect x='176' y='0' width='22' height='22'/><rect x='22' y='22' width='22' height='22'/><rect x='66' y='22' width='22' height='22'/><rect x='110' y='22' width='22' height='22'/><rect x='154' y='22' width='22' height='22'/><rect x='198' y='22' width='22' height='22'/></g><path d='M-10 170 L230 120' stroke='%23ef4444' stroke-width='14' stroke-opacity='0.12'/></svg>");
<svg xmlns='http://www.w3.org/2000/svg' width='260' height='260' viewBox='0 0 260 260'>\
<rect width='260' height='260' fill='%23f8fafc'/>\
<g fill='%230f172a' fill-opacity='0.06'>\
<rect x='0' y='0' width='32' height='32'/><rect x='64' y='0' width='32' height='32'/><rect x='128' y='0' width='32' height='32'/><rect x='192' y='0' width='32' height='32'/>\
<rect x='32' y='32' width='32' height='32'/><rect x='96' y='32' width='32' height='32'/><rect x='160' y='32' width='32' height='32'/><rect x='224' y='32' width='32' height='32'/>\
<rect x='0' y='64' width='32' height='32'/><rect x='64' y='64' width='32' height='32'/><rect x='128' y='64' width='32' height='32'/><rect x='192' y='64' width='32' height='32'/>\
</g>\
<path d='M-20 185 L280 130' stroke='%23ef4444' stroke-width='20' stroke-opacity='0.18'/>\
</svg>");
    --accent:#ef4444;
    --accent2:#111827;
  }

  /* Cool: Carbon Weave */
  [data-theme="carbon"]{
    --bgImg: url("data:image/svg+xml;utf8,\
    --innerImg: repeating-linear-gradient(45deg, rgba(255,255,255,.06) 0 10px, rgba(255,255,255,0) 10px 22px), repeating-linear-gradient(-45deg, rgba(255,255,255,.04) 0 10px, rgba(255,255,255,0) 10px 22px), radial-gradient(circle at 70% 30%, rgba(34,197,94,.10), transparent 55%);utf8,<svg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'><rect width='240' height='240' fill='none'/><g fill='%23ffffff' fill-opacity='0.05'><path d='M0 24 L24 0 L144 0 L120 24 Z'/><path d='M120 24 L144 0 L240 0 L216 24 Z'/><path d='M0 144 L24 120 L144 120 L120 144 Z'/><path d='M120 144 L144 120 L240 120 L216 144 Z'/></g></svg>");
<svg xmlns='http://www.w3.org/2000/svg' width='240' height='240' viewBox='0 0 240 240'>\
<rect width='240' height='240' fill='%230b1220'/>\
<g fill='%23ffffff' fill-opacity='0.045'>\
<path d='M0 22 L22 0 L132 0 L110 22 Z'/><path d='M110 22 L132 0 L240 0 L218 22 Z'/>\
<path d='M0 132 L22 110 L132 110 L110 132 Z'/><path d='M110 132 L132 110 L240 110 L218 132 Z'/>\
</g>\
<g fill='%23ffffff' fill-opacity='0.03'>\
<path d='M22 0 L44 22 L154 22 L132 0 Z'/><path d='M132 0 L154 22 L240 22 L218 0 Z'/>\
<path d='M22 110 L44 132 L154 132 L132 110 Z'/><path d='M132 110 L154 132 L240 132 L218 110 Z'/>\
</g>\
</svg>");
    --accent:#22c55e;
    --accent2:#60a5fa;
  }

  /* =========================
     Base layout
     ========================= */
  *{box-sizing:border-box}
  body{
    margin:0;
    background: var(--bgOverlay), var(--bgImg), var(--bg);
    background-size:auto, 280px 280px, auto;
    color:var(--ink);
    font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1050px;margin:18px auto;padding:16px}
  .card{
    background: var(--innerOverlay), var(--innerImg), var(--cardTint);
    background-size: auto, 260px 260px, auto;
    background-position: center, top left, center;
    border:1px solid var(--line);
    border-radius:18px;
    padding:18px;
    box-shadow:var(--shadow);
    backdrop-filter: blur(6px);
  }
  h1{
    margin:8px 0 10px;
    font-weight:950;
    text-align:center;
    font-size:32px;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    -webkit-background-clip:text;background-clip:text;color:transparent;
  }

  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .mini{font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line2);border-radius:999px;padding:6px 12px;background:transparent}
  .dot{width:12px;height:12px;border-radius:50%}

  button{border:0;background:transparent;cursor:pointer;font-weight:900;color:var(--ink)}
  button:focus{outline:none}
  .btnRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  /* round icon buttons (no outline, clean) */
  .round{
    width:36px;height:36px;
    display:inline-flex;align-items:center;justify-content:center;
    border-radius:999px;
    background:var(--panelTint);
    border:0;
    box-shadow:0 6px 18px rgba(2,6,23,.06);
    transition:transform .06s ease, filter .12s ease;
  }
  .round:hover{filter:brightness(1.02)}
  .round:active{transform:translateY(1px)}

  .themeBtn{
    width:36px;height:36px;
    border-radius:999px;
    background:var(--panelTint);
    border:0;
    display:inline-flex;align-items:center;justify-content:center;
    box-shadow:0 6px 18px rgba(2,6,23,.06);
  }
  .themeBtn .sw{
    width:16px;height:16px;border-radius:6px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
  }

  .modeBtn{
    display:inline-flex;align-items:center;gap:8px;
    padding:9px 12px;
    border-radius:999px;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    color:var(--accentText);
    font-weight:950;
    box-shadow:0 10px 26px rgba(2,6,23,.14);
  }

  input[type=text], select{
    width:100%;
    border:1px solid var(--line2);
    border-radius:14px;
    padding:10px 12px;
    background:var(--panelTint);
    color:var(--ink);
    outline:none;
    backdrop-filter: blur(6px);
  }
  select{cursor:pointer}
  .hr{height:1px;background:var(--line);margin:14px 0;border-radius:1px}
  .center{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap}
  .hidden{display:none !important}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media(max-width:900px){ .row2{grid-template-columns:1fr} }

  .panel{
    background: var(--innerOverlay), var(--innerImg), var(--panelTint);
    background-size: auto, 260px 260px, auto;
    background-position: center, top left, center;
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
    backdrop-filter: blur(6px);
  }
  .title{font-weight:950;margin:2px 0 6px}

  .primaryBtn{
    border-radius:14px;
    padding:10px 14px;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    color:var(--accentText);
    font-weight:950;
    box-shadow:0 12px 28px rgba(2,6,23,.14);
  }
  .softBtn{
    border:1px solid var(--line2);
    background:var(--panelTint);
    border-radius:14px;
    padding:10px 14px;
    font-weight:950;
  }
  .softBtn:disabled,.primaryBtn:disabled{opacity:.55;cursor:not-allowed}

  /* GAME */
  .gameGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;align-items:start}
  @media(max-width:900px){ .gameGrid{grid-template-columns:1fr} }
  .turnBanner{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .bigSecret{
    font-size:28px;font-weight:1000;letter-spacing:6px;
    padding:10px 14px;border-radius:16px;border:1px dashed var(--line2);
    display:inline-flex;align-items:center;gap:10px;background:transparent;
  }
  .boxes{display:flex;gap:8px;flex-wrap:wrap}
  .digitBox{width:54px;height:54px;border-radius:16px;border:1px solid var(--line2);display:flex;align-items:center;justify-content:center;background:transparent}
  .digitBox input{width:100%;height:100%;border:0;outline:none;background:transparent;color:var(--ink);text-align:center;font-size:20px;font-weight:950}
  .statusLine{font-weight:950}
  .statusLine.good{color:#16a34a}
  .statusLine.warn{color:#f59e0b}

  /* LOBBY players list (status next to name on left) */
  .playerLine{
    display:flex;align-items:center;justify-content:space-between;gap:12px;
    border:1px solid var(--line);
    border-radius:14px;
    padding:10px 12px;
    margin-top:8px;
    background:transparent;
  }
  .pLeft{display:flex;align-items:center;gap:10px;min-width:0}
  .pName{font-weight:950;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pStatus{font-size:12px;margin-top:2px}
  .pStatus.ok{color:#16a34a}
  .pStatus.wait{color:#f59e0b}
  .roleTag{font-size:11px;font-weight:950;padding:3px 10px;border-radius:999px;border:1px solid var(--line2);color:var(--muted)}

  /* HISTORY */
  .history{max-height:360px;overflow:auto;padding-right:6px}
  .logItem{border:1px solid var(--line);border-radius:14px;padding:10px 10px;margin:8px 0;background:transparent}
  .logTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .tag{font-size:11px;font-weight:950;padding:3px 8px;border-radius:999px;border:1px solid var(--line2);color:var(--muted)}
  .guess{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;font-size:18px;font-weight:950;letter-spacing:3px}
  .ago{font-size:11px;color:var(--muted);margin-top:4px}

  .smallTabs{display:flex;gap:8px}
  .smallTabs button{padding:7px 10px;border-radius:12px;font-size:13px;border:1px solid var(--line2);background:var(--panelTint)}
  .smallTabs button.active{background:linear-gradient(90deg,var(--accent),var(--accent2));color:var(--accentText);border-color:transparent}

  /* MODALS */
  .modalBack{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999;padding:16px}
  .modalBack.show{display:flex}
  .modal{max-width:780px;width:100%;background:var(--cardTint);border:1px solid var(--line);border-radius:18px;padding:16px;box-shadow:var(--shadow);backdrop-filter: blur(8px)}
  .modal h2{margin:0 0 10px;font-size:22px}
  .winnerName{font-size:28px;font-weight:1000;background:linear-gradient(90deg,var(--accent),var(--accent2));-webkit-background-clip:text;background-clip:text;color:transparent}

  /* CONFETTI */
  .confetti{position:fixed; inset:0; pointer-events:none; z-index:9998; overflow:hidden;}
  .confetti i{position:absolute; top:-20px; width:10px; height:14px; border-radius:3px; opacity:.95; animation:confFall linear forwards;}
  @keyframes confFall{to{transform: translateY(110vh) rotate(720deg); opacity: 1;}}
</style>
</head>

<body>
<div class="confetti" id="confetti"></div>

<!-- Theme Picker Modal -->
<div class="modalBack" id="themeBack">
  <div class="modal">
    <h2>Choose a theme</h2>
    <div class="mini" style="margin-bottom:10px">Theme changes background style. Dark/Light changes mode.</div>

    <div class="row2">
      <button class="softBtn" data-theme-pick="blush">üíó Blush (soft)</button>
      <button class="softBtn" data-theme-pick="lavender">üíú Lavender (soft)</button>
      <button class="softBtn" data-theme-pick="sky">ü©µ Sky (soft)</button>
      <button class="softBtn" data-theme-pick="neon">‚ú® Neon (cool)</button>
      <button class="softBtn" data-theme-pick="racer">üèÅ Racer (cool)</button>
      <button class="softBtn" data-theme-pick="carbon">üñ§ Carbon (cool)</button>
    </div>

    <div class="center" style="justify-content:flex-end;margin-top:12px">
      <button id="themeClose" class="softBtn">Close</button>
    </div>
  </div>
</div>

<!-- Rules Modal -->
<div class="modalBack" id="rulesBack">
  <div class="modal">
    <h2>How to Play</h2>
    <div class="mini" style="margin-bottom:10px">2 players ‚Ä¢ turn-by-turn ‚Ä¢ first to crack opponent‚Äôs code wins.</div>

    <div class="panel" style="margin-bottom:10px">
      <div class="title">Lobby</div>
      <ul style="margin:6px 0 0 18px">
        <li>Create room ‚Üí share room code ‚Üí second player joins.</li>
        <li>Select digits (3/4/5/6). Changing digits resets secrets automatically.</li>
        <li>Both players lock a secret to start.</li>
      </ul>
    </div>

    <div class="panel">
      <div class="title">Guessing</div>
      <ul style="margin:6px 0 0 18px">
        <li>Enter a guess with the same digit count.</li>
        <li>Feedback:
          <ul>
            <li><b>X numbers correct</b> (digits exist anywhere)</li>
            <li><b>Y positions correct</b> (digit + position correct)</li>
          </ul>
        </li>
        <li>History shows guesses + feedback + time (e.g., 12s ago).</li>
      </ul>
    </div>

    <div class="center" style="justify-content:flex-end;margin-top:12px">
      <button id="closeRules" class="primaryBtn">Got it</button>
    </div>
  </div>
</div>

<!-- Winner Modal -->
<div class="modalBack" id="winnerBack">
  <div class="modal">
    <h2>üèÜ Winner</h2>
    <div class="winnerName" id="winnerName">-</div>
    <div class="mini" style="margin-top:6px">Click ‚ÄúOne more game‚Äù to go back to lobby.</div>
    <div class="center" style="justify-content:flex-end;margin-top:12px">
      <button id="winnerNext" class="primaryBtn">üîÅ One more game</button>
      <button id="winnerClose" class="softBtn">Close</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">

    <div class="topbar">
      <div class="pill" style="gap:10px">
        <span class="mini">Room</span>
        <b id="roomTop">-</b>
        <!-- Copy ONLY visible in lobby -->
        <button id="copyRoom" class="softBtn" style="padding:7px 10px;border-radius:999px;display:none">üìã Copy</button>
      </div>

      <!-- Top right: (i), (themes), Dark/Light -->
      <div class="btnRow">
        <button id="rulesBtn" class="round" title="Rules"><b>i</b></button>
        <button id="themeBtn" class="themeBtn" title="Themes"><span class="sw"></span></button>
        <button id="modeBtn" class="modeBtn" title="Dark/Light">üåô Dark</button>
      </div>
    </div>

    <h1>Crack the Code</h1>

    <!-- Tip ONLY on very first screen -->
    <div id="tipLine" class="mini" style="text-align:center;margin-bottom:12px">
      Tip: If you leave name empty, default will be Player A / Player B.
    </div>

    <!-- Step: Choose -->
    <div id="step-choose" class="center" style="margin:8px 0 6px">
      <button id="btnCreate" class="primaryBtn">Create Room</button>
      <button id="btnJoin" class="softBtn">Join Room</button>
    </div>

    <!-- Create -->
    <div id="step-create" class="hidden">
      <div class="row2">
        <div>
          <div class="title">Your Name</div>
          <input id="createName" type="text" placeholder="e.g., Player A" />
        </div>
        <div>
          <div class="title">Room Code</div>
          <input id="createCode" type="text" readonly />
        </div>
      </div>
      <div class="center" style="margin-top:10px">
        <button id="createGo" class="primaryBtn">Create & Enter Lobby</button>
        <button id="back1" class="softBtn">Back</button>
      </div>
    </div>

    <!-- Join -->
    <div id="step-join" class="hidden">
      <div class="row2">
        <div>
          <div class="title">Your Name</div>
          <input id="joinName" type="text" placeholder="e.g., Player B" />
        </div>
        <div>
          <div class="title">Room Code</div>
          <input id="joinCode" type="text" placeholder="ABCDE" />
        </div>
      </div>
      <div class="center" style="margin-top:10px">
        <button id="joinGo" class="primaryBtn">Join Lobby</button>
        <button id="back2" class="softBtn">Back</button>
      </div>
    </div>

    <!-- Lobby -->
    <div id="step-lobby" class="hidden">
      <div class="row2">
        <div class="panel">
          <div class="title">Lobby</div>
          <div class="mini">2 players only ‚Ä¢ status updates automatically.</div>
          <div id="playersList"></div>
        </div>

        <div class="panel">
          <div class="title">Game setup</div>

          <div class="mini" style="margin-bottom:6px">Digits</div>
          <select id="digitsSel">
            <option value="3">3 digits (‚âà 5‚Äì10 min)</option>
            <option value="4" selected>4 digits (‚âà 10‚Äì20 min)</option>
            <option value="5">5 digits (‚âà 20‚Äì35 min)</option>
            <option value="6">6 digits (‚âà 35‚Äì60 min)</option>
          </select>

          <div class="mini" style="margin-top:8px">Changing digits resets secrets automatically.</div>

          <div class="hr"></div>

          <div class="title">Set your secret</div>
          <div class="mini" style="margin-bottom:8px">
            Enter exactly <b id="digitCountLabel">4</b> digits.
          </div>
          <div class="boxes" id="secretBoxes"></div>

          <div class="center" style="margin-top:10px;justify-content:flex-start">
            <button id="setSecretBtn" class="primaryBtn">Lock Secret</button>
            <button id="clearSecretBtn" class="softBtn">Clear</button>
          </div>

          <div class="mini" style="margin-top:10px" id="secretStatus"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="center">
        <button id="goGameBtn" class="primaryBtn hidden">Go to Game</button>
      </div>
    </div>

    <!-- Game -->
    <div id="step-game" class="hidden">
      <div class="gameGrid">
        <!-- Left -->
        <div class="panel">
          <div class="turnBanner">
            <div class="pill">
              <span class="mini">You</span>&nbsp;<span id="youDot" class="dot"></span>&nbsp;<b id="youName">-</b>
            </div>
            <div class="pill">
              <span class="mini">Turn</span>&nbsp;<b id="turnName">-</b>
            </div>
          </div>

          <div class="hr"></div>

          <div class="title">Your secret</div>
          <div class="bigSecret">
            <span id="mySecretDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button id="toggleSecret" class="round" title="Show/Hide">üëÅÔ∏è</button>
          </div>

          <div class="hr"></div>

          <div class="title">Enter your guess</div>
          <div class="mini" style="margin-bottom:8px">
            Enter <b id="guessDigitCount">4</b> digits. (Enter key submits)
          </div>

          <div class="boxes" id="guessBoxes"></div>

          <div class="center" style="margin-top:10px;justify-content:flex-start">
            <button id="submitGuess" class="primaryBtn">Submit Guess</button>
            <button id="clearGuess" class="softBtn">Clear</button>
          </div>

          <div class="mini" style="margin-top:10px" id="lastFeedback">Waiting‚Ä¶</div>

          <div class="hr"></div>
          <div class="center" style="justify-content:flex-end">
            <button id="oneMoreGame" class="primaryBtn hidden">üîÅ One more game</button>
          </div>
        </div>

        <!-- Right -->
        <div class="panel">
          <div class="title">History</div>

          <div class="smallTabs" style="margin-top:8px">
            <button id="tabMine" class="active">Mine</button>
            <button id="tabOpp">Opponent</button>
          </div>

          <div class="hr"></div>
          <div class="history" id="historyList"></div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
/* ==========================
   Firebase Config (REPLACE)
   ========================== */
const firebaseConfig = {
  apiKey: "AIzaSyDIL-Awme_yTv9Jt7tSdX2WI2BkOlbHTlI",
  authDomain: "crack-the-code-game-35615.firebaseapp.com",
  projectId: "crack-the-code-game-35615",
  storageBucket: "crack-the-code-game-35615.firebasestorage.app",
  messagingSenderId: "281951990500",
  appId: "1:281951990500:web:ab19ad486b05477e06b2f1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==========================
   Theme + Mode boot
   - Theme loads on first screen (random if none saved)
   - Dark/Light is separate from theme
   ========================== */
const THEMES = ["blush","lavender","sky","neon","racer","carbon"];

function setTheme(theme){
  if(!THEMES.includes(theme)) theme = "blush";
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("ctc_theme", theme);
}
function setMode(mode){
  mode = (mode === "dark") ? "dark" : "light";
  document.documentElement.setAttribute("data-mode", mode);
  localStorage.setItem("ctc_mode", mode);
  document.getElementById("modeBtn").textContent = (mode === "dark") ? "‚òÄÔ∏è Light" : "üåô Dark";
}
function initThemeAndMode(){
  const savedTheme = localStorage.getItem("ctc_theme");
  const theme = (savedTheme && THEMES.includes(savedTheme))
    ? savedTheme
    : THEMES[Math.floor(Math.random()*THEMES.length)];
  setTheme(theme);

  const savedMode = localStorage.getItem("ctc_mode");
  if(savedMode === "dark" || savedMode === "light") setMode(savedMode);
  else setMode("dark");
}

/* ==========================
   State
   ========================== */
const PASTEL = ["#ff6b6b","#60a5fa","#34d399","#fbbf24","#a78bfa","#22d3ee","#f472b6","#86efac"];

let my = { pid:null, name:"", color:"", room:"" };

let roomState = {
  settings:{ digits:4 },
  order: [],
  players: {},
  secrets: {},
  started: false,
  turnPid: null,
  winner: null,
  stage: "lobby",
  guessesList: []
};

let currentTab = "mine";
let revealSecret = false;
let elapsedTimer = null;

let secretUI = null;
let guessUI = null;

/* ==========================
   Helpers
   ========================== */
const $ = id => document.getElementById(id);
const show = id => $(id).classList.remove("hidden");
const hide = id => $(id).classList.add("hidden");

function roomCode(){ return Math.random().toString(36).substring(2,7).toUpperCase(); }
function now(){ return Date.now(); }

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function agoText(ts){
  const d = Math.max(0, now() - (ts||now()));
  const sec = Math.floor(d/1000);
  if(sec < 5) return "just now";
  if(sec < 60) return `${sec}s ago`;
  const min = Math.floor(sec/60);
  if(min < 60) return `${min}m ago`;
  const hr = Math.floor(min/60);
  if(hr < 24) return `${hr}h ago`;
  const day = Math.floor(hr/24);
  return `${day}d ago`;
}
function validDigitsString(val, digits){
  return new RegExp(`^\\d{${digits}}$`).test((val||"").trim());
}

function buildDigitBoxes(hostId, digits, opts={}){
  const host = $(hostId);
  host.innerHTML = "";
  const inputs = [];

  const getValue = () => inputs.map(x => x.value).join("");
  const focusFirstEmpty = () => {
    const firstEmpty = inputs.find(i => !i.value);
    (firstEmpty || inputs[0])?.focus();
  };
  const clear = () => { inputs.forEach(i => i.value=""); focusFirstEmpty(); };

  for(let i=0;i<digits;i++){
    const wrap = document.createElement("div");
    wrap.className = "digitBox";
    const inp = document.createElement("input");
    inp.type = "text";
    inp.inputMode = "numeric";
    inp.autocomplete = "one-time-code";
    inp.maxLength = 1;
    inp.placeholder = "0";

    inp.addEventListener("input", () => {
      inp.value = inp.value.replace(/[^0-9]/g,"").slice(0,1);
      if(inp.value && i < digits-1) inputs[i+1].focus();
      opts.onChange && opts.onChange(getValue());
    });

    inp.addEventListener("keydown", (e) => {
      if(e.key === "Backspace" && !inp.value && i>0){
        inputs[i-1].focus();
      }
      if(e.key === "Enter"){
        opts.onEnter && opts.onEnter(getValue());
      }
    });

    wrap.appendChild(inp);
    host.appendChild(wrap);
    inputs.push(inp);
  }

  return { focus: focusFirstEmpty, getValue, clear };
}

function countMatches(secret, guess){
  const n = secret.length;
  let posCorrect = 0;
  for(let i=0;i<n;i++){ if(secret[i] === guess[i]) posCorrect++; }

  const freqS = {}, freqG = {};
  for(const ch of secret){ freqS[ch] = (freqS[ch]||0)+1; }
  for(const ch of guess){  freqG[ch] = (freqG[ch]||0)+1; }

  let numCorrect = 0;
  for(const d in freqS){
    if(freqG[d]) numCorrect += Math.min(freqS[d], freqG[d]);
  }
  return { numCorrect, posCorrect };
}
function formatFeedback(numCorrect, posCorrect){
  const n = numCorrect, p = posCorrect;
  return `${n} number${n===1?"":"s"} correct, ${p} position${p===1?"":"s"} correct`;
}

/* ==========================
   Confetti (paper pieces)
   ========================== */
function launchConfetti(){
  const c=$("confetti"); c.innerHTML="";
  const colors=["#ef4444","#f59e0b","#10b981","#3b82f6","#a855f7","#22d3ee","#f472b6","#84cc16"];
  const pieces = 220;
  for(let i=0;i<pieces;i++){
    const p=document.createElement("i");
    const w = 6 + Math.random()*8;
    const h = 8 + Math.random()*12;
    p.style.width = w+"px";
    p.style.height = h+"px";
    p.style.left = (Math.random()*100) + "vw";
    p.style.background = colors[i % colors.length];
    p.style.opacity = (0.7 + Math.random()*0.3).toFixed(2);
    p.style.borderRadius = (Math.random() < 0.3) ? "999px" : "3px";
    p.style.animationDuration = (1.7 + Math.random()*2.0) + "s";
    p.style.animationDelay = (Math.random()*0.15) + "s";
    c.appendChild(p);
  }
  setTimeout(()=>{ c.innerHTML=""; }, 3800);
}

/* ==========================
   UI Navigation
   ========================== */
function goto(step){
  ["step-choose","step-create","step-join","step-lobby","step-game"].forEach(hide);
  show(step);

  // Tip only on first screen
  $("tipLine").style.display = (step === "step-choose") ? "block" : "none";

  // Copy ONLY on lobby
  $("copyRoom").style.display = (step === "step-lobby") ? "inline-flex" : "none";
}

$("btnCreate").onclick = () => { goto("step-create"); $("createCode").value = roomCode(); };
$("btnJoin").onclick = () => goto("step-join");
$("back1").onclick = () => goto("step-choose");
$("back2").onclick = () => goto("step-choose");

/* Rules modal */
$("rulesBtn").onclick = () => $("rulesBack").classList.add("show");
$("closeRules").onclick = () => $("rulesBack").classList.remove("show");
$("rulesBack").onclick = (e) => { if(e.target.id === "rulesBack") $("rulesBack").classList.remove("show"); };

/* Theme modal */
$("themeBtn").onclick = () => $("themeBack").classList.add("show");
$("themeClose").onclick = () => $("themeBack").classList.remove("show");
$("themeBack").onclick = (e) => { if(e.target.id === "themeBack") $("themeBack").classList.remove("show"); };
document.querySelectorAll("[data-theme-pick]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    setTheme(btn.getAttribute("data-theme-pick"));
    $("themeBack").classList.remove("show");
  });
});

/* Mode toggle */
$("modeBtn").onclick = () => {
  const cur = document.documentElement.getAttribute("data-mode") || "light";
  setMode(cur === "dark" ? "light" : "dark");
};

/* Winner modal */
$("winnerClose").onclick = () => $("winnerBack").classList.remove("show");
$("winnerBack").onclick = (e) => { if(e.target.id === "winnerBack") $("winnerBack").classList.remove("show"); };

/* Copy room code (only visible on lobby) */
$("copyRoom").onclick = async () => {
  const r = $("roomTop").textContent || "";
  if(!r || r === "-") return;
  try{
    await navigator.clipboard.writeText(r);
    $("copyRoom").textContent = "‚úÖ";
    setTimeout(()=> $("copyRoom").textContent = "üìã Copy", 800);
  }catch(e){
    alert("Copy failed. Please copy manually.");
  }
};

/* ==========================
   Create / Join Room
   - Player name input ONLY here
   ========================== */
async function createOrJoin({mode, nickname, roomCode}){
  const room = roomCode.trim().toUpperCase();
  if(!room) return alert("Room code missing.");

  const roomRef = db.ref(`rooms/${room}`);
  const snap = await roomRef.get();

  if(mode === "create"){
    if(snap.exists()) return alert("Room already exists. Try a new code.");

    const pid = "p" + Date.now();
    my = { pid, name: nickname.trim() || "Player A", color: PASTEL[0], room };

    await roomRef.set({
      createdAt: now(),
      stage: "lobby",
      settings: { digits: 4 },
      order: [pid],
      turnPid: null,
      started: false,
      winner: null,
      resetAt: now()
    });

    await db.ref(`rooms/${room}/players/${pid}`).set({
      nickname: my.name,
      color: my.color,
      hasSecret: false
    });

  } else {
    if(!snap.exists()) return alert("Room not found.");

    const orderSnap = await db.ref(`rooms/${room}/order`).get();
    const order = orderSnap.val() || [];
    if(order.length >= 2) return alert("Room already has 2 players.");

    const pid = "p" + Date.now();
    const idx = order.length;
    my = { pid, name: nickname.trim() || (idx===0 ? "Player A" : "Player B"), color: PASTEL[idx%PASTEL.length], room };

    await db.ref(`rooms/${room}/order`).set([...order, pid]);
    await db.ref(`rooms/${room}/players/${pid}`).set({
      nickname: my.name,
      color: my.color,
      hasSecret: false
    });
  }

  $("roomTop").textContent = my.room;
  attachRoomListeners();
  goto("step-lobby");
}

$("createGo").onclick = () => createOrJoin({
  mode: "create",
  nickname: $("createName").value,
  roomCode: $("createCode").value
});
$("joinGo").onclick = () => createOrJoin({
  mode: "join",
  nickname: $("joinName").value,
  roomCode: $("joinCode").value
});

/* ==========================
   Lobby & digits
   ========================== */
function updateDigitsUI(digits){
  $("digitCountLabel").textContent = digits;
  $("guessDigitCount").textContent = digits;
  $("digitsSel").value = String(digits);

  secretUI = buildDigitBoxes("secretBoxes", digits);
  guessUI = buildDigitBoxes("guessBoxes", digits, {
    onEnter: (val) => {
      // Enter submits (desktop + mobile external keyboards)
      if(validDigitsString(val, digits) && isMyTurn() && !roomState.winner) {
        submitGuessInternal().catch(()=>{});
      }
    }
  });

  revealSecret = false;
  $("mySecretDisplay").textContent = "‚Ä¢".repeat(digits);
}

function renderPlayersList(){
  const host = $("playersList");
  host.innerHTML = "";

  const order = roomState.order || [];
  if(order.length === 0){
    host.innerHTML = `<div class="mini">Waiting‚Ä¶</div>`;
    return;
  }

  order.forEach((pid, idx) => {
    const p = roomState.players?.[pid] || {};
    const name = p.nickname || (idx===0 ? "Player A" : "Player B");
    const has = !!p.hasSecret;

    const line = document.createElement("div");
    line.className = "playerLine";

    // status shown next to name on left
    line.innerHTML = `
      <div class="pLeft">
        <span class="dot" style="background:${p.color||"#999"}"></span>
        <div style="min-width:0">
          <div class="pName">${escapeHtml(name)}</div>
          <div class="pStatus ${has ? "ok" : "wait"}">${has ? "Secret set ‚úÖ" : "Secret not set"}</div>
        </div>
      </div>
      <span class="roleTag">${idx===0 ? "Player A" : "Player B"}</span>
    `;
    host.appendChild(line);
  });

  if(order.length < 2){
    const wait = document.createElement("div");
    wait.className = "mini";
    wait.style.marginTop = "10px";
    wait.textContent = "Waiting for second player to join‚Ä¶";
    host.appendChild(wait);
  }
}

function lobbyStatusText(){
  const order = roomState.order || [];
  if(order.length < 2) return `<span class="statusLine warn">Waiting for second player‚Ä¶</span>`;
  const pA = roomState.players?.[order[0]];
  const pB = roomState.players?.[order[1]];
  if(!(pA?.hasSecret && pB?.hasSecret)) return `<span class="statusLine warn">Waiting until both players lock secrets‚Ä¶</span>`;
  return `<span class="statusLine good">Both secrets ready. Starting game‚Ä¶</span>`;
}

function canStart(){
  const order = roomState.order || [];
  if(order.length !== 2) return false;
  const pA = roomState.players?.[order[0]];
  const pB = roomState.players?.[order[1]];
  return !!(pA?.hasSecret && pB?.hasSecret);
}

async function ensureStartIfReady(){
  if(roomState.started) return;
  if(canStart()){
    const order = roomState.order;
    const firstPid = order[0];
    await db.ref(`rooms/${my.room}`).update({
      started: true,
      stage: "game",
      turnPid: firstPid,
      winner: null
    });
  }
}

$("goGameBtn").onclick = () => goto("step-game");

/* Digits change: reset secrets + guesses immediately (both players) */
$("digitsSel").onchange = async () => {
  const digits = parseInt($("digitsSel").value, 10);
  if(!Number.isInteger(digits) || digits < 3 || digits > 6) return;
  await resetToLobby({ digits, reason: "digitsChanged" });
};

async function resetToLobby({digits, reason}){
  const base = `rooms/${my.room}`;
  const players = roomState.players || {};
  const updates = {};

  Object.keys(players).forEach(pid => {
    updates[`${base}/players/${pid}/hasSecret`] = false;
  });

  updates[`${base}/secrets`] = null;
  updates[`${base}/guesses`] = null;
  updates[`${base}/started`] = false;
  updates[`${base}/stage`] = "lobby";
  updates[`${base}/turnPid`] = null;
  updates[`${base}/winner`] = null;
  updates[`${base}/resetAt`] = now();
  updates[`${base}/settings/digits`] = digits ?? (roomState.settings?.digits || 4);
  updates[`${base}/lastResetReason`] = reason || "manual";

  await db.ref().update(updates);

  secretUI?.clear();
  guessUI?.clear();
}

/* Lock secret */
$("setSecretBtn").onclick = async () => {
  const digits = roomState.settings?.digits || 4;
  const val = (secretUI?.getValue() || "").trim();
  if(!validDigitsString(val, digits)) return alert(`Enter exactly ${digits} digits.`);

  await db.ref(`rooms/${my.room}/secrets/${my.pid}`).set(val);
  await db.ref(`rooms/${my.room}/players/${my.pid}/hasSecret`).set(true);

  $("secretStatus").innerHTML = `<span class="statusLine good">Secret locked. Waiting for opponent‚Ä¶</span>`;
};

$("clearSecretBtn").onclick = () => secretUI?.clear();

/* ==========================
   Game Logic
   ========================== */
function myOpponentPid(){
  const order = roomState.order || [];
  if(order.length !== 2) return null;
  return order[0] === my.pid ? order[1] : order[0];
}
function isMyTurn(){ return roomState.turnPid === my.pid; }

function renderGameHeader(){
  const me = roomState.players?.[my.pid] || {};
  $("youName").textContent = me.nickname || my.name || "You";
  $("youDot").style.background = me.color || my.color || "#999";

  const turnPid = roomState.turnPid;
  const turnName = roomState.players?.[turnPid]?.nickname || "-";
  $("turnName").textContent = turnName;

  const digits = roomState.settings?.digits || 4;
  const mySecret = roomState.secrets?.[my.pid] || "";
  $("mySecretDisplay").textContent = (revealSecret && mySecret) ? mySecret : "‚Ä¢".repeat(digits);

  const disabled = !roomState.started || !!roomState.winner || !isMyTurn();
  $("submitGuess").disabled = disabled;
  $("clearGuess").disabled = disabled;

  if(roomState.winner){
    const name = roomState.winner.name || "Winner";
    $("lastFeedback").innerHTML = `<span class="statusLine good">Game ended. Winner: <b>${escapeHtml(name)}</b></span>`;
    show("oneMoreGame");
  } else {
    hide("oneMoreGame");
    if(!roomState.started){
      $("lastFeedback").innerHTML = `<span class="statusLine warn">Waiting for game to start‚Ä¶</span>`;
    } else if(isMyTurn()){
      $("lastFeedback").innerHTML = `<span class="statusLine good">Your turn. Enter a guess.</span>`;
      // autofocus (mobile keypad opens)
      setTimeout(()=> guessUI?.focus(), 60);
    } else {
      $("lastFeedback").innerHTML = `<span class="statusLine warn">Opponent's turn‚Ä¶</span>`;
    }
  }
}

$("toggleSecret").onclick = () => { revealSecret = !revealSecret; renderGameHeader(); };
$("clearGuess").onclick = () => guessUI?.clear();

async function submitGuessInternal(){
  if(!isMyTurn()) return alert("Not your turn.");
  if(roomState.winner) return;

  const digits = roomState.settings?.digits || 4;
  const guess = (guessUI?.getValue() || "").trim();
  if(!validDigitsString(guess, digits)) return alert(`Enter exactly ${digits} digits.`);

  const oppPid = myOpponentPid();
  const oppSecret = roomState.secrets?.[oppPid];
  if(!oppSecret) return alert("Opponent secret not ready.");

  const { numCorrect, posCorrect } = countMatches(oppSecret, guess);
  const feedback = formatFeedback(numCorrect, posCorrect);

  const gRef = db.ref(`rooms/${my.room}/guesses`).push();
  await gRef.set({ by: my.pid, guess, numCorrect, posCorrect, feedback, ts: now() });

  if(guess === oppSecret){
    const winnerName = roomState.players?.[my.pid]?.nickname || my.name || "Winner";
    await db.ref(`rooms/${my.room}/winner`).set({ pid: my.pid, name: winnerName, at: now() });
    return;
  }

  await db.ref(`rooms/${my.room}/turnPid`).set(oppPid);
  guessUI?.clear();
}

$("submitGuess").onclick = () => submitGuessInternal().catch(()=>{});

/* Next game resets BOTH players to lobby */
$("oneMoreGame").onclick = async () => {
  const digits = roomState.settings?.digits || 4;
  await resetToLobby({ digits, reason: "nextGame" });
};
$("winnerNext").onclick = async () => {
  $("winnerBack").classList.remove("show");
  const digits = roomState.settings?.digits || 4;
  await resetToLobby({ digits, reason: "winnerNext" });
};

/* ==========================
   History
   ========================== */
function setTab(tab){
  currentTab = tab;
  $("tabMine").classList.toggle("active", tab === "mine");
  $("tabOpp").classList.toggle("active", tab === "opp");
  renderHistory();
}
$("tabMine").onclick = () => setTab("mine");
$("tabOpp").onclick  = () => setTab("opp");

function renderHistory(){
  const host = $("historyList");
  host.innerHTML = "";

  const guesses = roomState.guessesList || [];
  const oppPid = myOpponentPid();

  const filtered = guesses.filter(g => currentTab === "mine" ? g.by === my.pid : g.by === oppPid);

  if(filtered.length === 0){
    host.innerHTML = `<div class="mini">No guesses yet.</div>`;
    return;
  }

  filtered.slice().reverse().forEach(g => {
    const byName = roomState.players?.[g.by]?.nickname || "Player";
    const item = document.createElement("div");
    item.className = "logItem";
    item.innerHTML = `
      <div class="logTop">
        <div><span class="tag">${escapeHtml(byName)}</span></div>
        <div class="guess">${escapeHtml(g.guess)}</div>
      </div>
      <div class="mini" style="margin-top:6px">${escapeHtml(g.feedback)}</div>
      <div class="ago" data-ts="${g.ts||0}">${agoText(g.ts||0)}</div>
    `;
    host.appendChild(item);
  });
}

function startElapsedUpdater(){
  if(elapsedTimer) return;
  elapsedTimer = setInterval(()=>{
    document.querySelectorAll("[data-ts]").forEach(el => {
      const ts = parseInt(el.getAttribute("data-ts"), 10) || 0;
      el.textContent = agoText(ts);
    });
  }, 5000);
}

/* ==========================
   Room listeners
   ========================== */
let roomUnsubs = [];

function detachRoomListeners(){
  roomUnsubs.forEach(fn => fn && fn());
  roomUnsubs = [];
}

function attachRoomListeners(){
  detachRoomListeners();

  const base = `rooms/${my.room}`;

  const on = (path, cb) => {
    const ref = db.ref(path);
    ref.on("value", cb);
    roomUnsubs.push(() => ref.off("value", cb));
  };

  on(`${base}`, (snap) => {
    const v = snap.val();
    if(!v) return;

    roomState.settings = v.settings || {digits:4};
    roomState.order = v.order || [];
    roomState.started = !!v.started;
    roomState.turnPid = v.turnPid || null;
    roomState.winner = v.winner || null;
    roomState.stage = v.stage || "lobby";

    $("roomTop").textContent = my.room;

    const digits = roomState.settings.digits || 4;
    updateDigitsUI(digits);

    if(roomState.stage === "game") goto("step-game");
    else goto("step-lobby");

    $("secretStatus").innerHTML = lobbyStatusText();

    if(roomState.stage === "lobby" && roomState.started) show("goGameBtn");
    else hide("goGameBtn");

    ensureStartIfReady().catch(()=>{});
    renderPlayersList();
    renderGameHeader();
    renderHistory();
    startElapsedUpdater();
  });

  on(`${base}/players`, (snap) => {
    roomState.players = snap.val() || {};
    renderPlayersList();
    $("secretStatus").innerHTML = lobbyStatusText();
    ensureStartIfReady().catch(()=>{});
    renderGameHeader();
  });

  on(`${base}/secrets`, (snap) => {
    roomState.secrets = snap.val() || {};
    $("secretStatus").innerHTML = lobbyStatusText();
    ensureStartIfReady().catch(()=>{});
    renderGameHeader();
  });

  on(`${base}/guesses`, (snap) => {
    const obj = snap.val() || {};
    const list = Object.entries(obj).map(([id, g]) => ({ id, ...g }));
    list.sort((a,b) => (a.ts||0) - (b.ts||0));
    roomState.guessesList = list;
    renderHistory();
  });

  on(`${base}/winner`, (snap) => {
    const w = snap.val();
    roomState.winner = w || null;

    if(w && w.name){
      $("winnerName").textContent = w.name;
      $("winnerBack").classList.add("show");
      launchConfetti();
    }
    renderGameHeader();
  });
}

/* ==========================
   Boot
   ========================== */
initThemeAndMode();
goto("step-choose");

// Autofocus guess area on tap (mobile)
document.addEventListener("click", (e) => {
  if(e.target.closest("#guessBoxes") && roomState.stage === "game" && isMyTurn() && !roomState.winner){
    guessUI?.focus();
  }
});

// Best-effort remove player on close
window.addEventListener("beforeunload", () => {
  try{
    if(my?.room && my?.pid){
      db.ref(`rooms/${my.room}/players/${my.pid}`).remove();
    }
  }catch(e){}
});
</script>

</body>
</html>
