<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crack the Code (2P Room)</title>

<style>
  /* =========================
     THEME SYSTEM (6 themes)
     ========================= */
  :root{
    --bg:#ffffff; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
    --line:#e2e8f0; --line2:#cbd5e1; --panel:#f8fafc;
    --accent:#2563eb; --accent2:#7c3aed; --accentText:#ffffff;
    --good:#16a34a; --warn:#f59e0b; --bad:#ef4444;
    --shadow:0 12px 34px rgba(2,6,23,.10);
  }
  [data-theme="dark"]{
    --bg:#0b1220; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8;
    --line:#22314a; --line2:#334155; --panel:#0b1327;
    --accent:#60a5fa; --accent2:#a78bfa; --accentText:#07101f;
    --shadow:0 18px 42px rgba(0,0,0,.42);
  }
  [data-theme="ocean"]{
    --bg:#06131a; --card:#0a1c26; --ink:#e6f6ff; --muted:#8ad3f0;
    --line:#0e3040; --line2:#1a465b; --panel:#07202c;
    --accent:#06b6d4; --accent2:#3b82f6; --accentText:#041016;
    --shadow:0 18px 42px rgba(0,0,0,.45);
  }
  [data-theme="sunset"]{
    --bg:#fff7ed; --card:#ffffff; --ink:#3b1a0a; --muted:#8a4b2e;
    --line:#fed7aa; --line2:#fdba74; --panel:#fff3e0;
    --accent:#f97316; --accent2:#ef4444; --accentText:#1b0b06;
    --shadow:0 12px 34px rgba(59,26,10,.12);
  }
  [data-theme="forest"]{
    --bg:#f0fdf4; --card:#ffffff; --ink:#052e16; --muted:#166534;
    --line:#bbf7d0; --line2:#86efac; --panel:#ecfdf5;
    --accent:#16a34a; --accent2:#0ea5e9; --accentText:#04120a;
    --shadow:0 12px 34px rgba(5,46,22,.12);
  }
  [data-theme="candy"]{
    --bg:#fff1f2; --card:#ffffff; --ink:#3f0d1f; --muted:#9f1239;
    --line:#fecdd3; --line2:#fda4af; --panel:#fff5f7;
    --accent:#ec4899; --accent2:#a855f7; --accentText:#1a0710;
    --shadow:0 12px 34px rgba(63,13,31,.12);
  }

  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1050px;margin:20px auto;padding:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:18px;box-shadow:var(--shadow)}
  h1{
    margin:8px 0 10px;font-weight:950;text-align:center;font-size:32px;letter-spacing:.2px;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    -webkit-background-clip:text;background-clip:text;color:transparent
  }

  .topbar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  .mini{font-size:12px;color:var(--muted)}
  .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line2);border-radius:999px;padding:6px 12px;background:transparent}
  .dot{width:12px;height:12px;border-radius:50%}

  .btnRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .iconBtn{
    display:inline-flex;align-items:center;gap:8px;
    border:1px solid var(--line2);
    background:var(--panel);
    color:var(--ink);
    border-radius:999px;
    padding:9px 12px;
    cursor:pointer;
    font-weight:900;
    transition:transform .06s ease, filter .12s ease;
  }
  .iconBtn:hover{filter:brightness(1.02)}
  .iconBtn:active{transform:translateY(1px)}
  .primary{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    border-color:transparent;
    color:var(--accentText);
  }
  button{
    border:1px solid var(--line2);background:var(--panel);
    border-radius:14px;padding:10px 14px;cursor:pointer;font-weight:900;color:var(--ink)
  }
  button.primary{
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    border-color:transparent;color:var(--accentText)
  }
  button.ghost{background:transparent}
  button:disabled{opacity:.55;cursor:not-allowed}

  input[type=text], select{
    width:100%;border:1px solid var(--line2);border-radius:14px;padding:10px 12px;
    background:transparent;color:var(--ink);outline:none
  }
  select{cursor:pointer}
  .hr{height:1px;background:var(--line);margin:14px 0;border-radius:1px}
  .center{display:flex;justify-content:center;align-items:center;gap:10px;flex-wrap:wrap}
  .hidden{display:none !important}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .row3{display:grid;grid-template-columns:1.2fr 1fr 1fr;gap:12px}
  @media(max-width:900px){ .row2,.row3{grid-template-columns:1fr} }

  .panel{
    background:var(--panel);
    border:1px solid var(--line);
    border-radius:16px;
    padding:12px;
  }
  .title{font-weight:950;margin:2px 0 6px}

  /* GAME */
  .gameGrid{
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:14px;
    align-items:start;
  }
  @media(max-width:900px){ .gameGrid{grid-template-columns:1fr} }

  .turnBanner{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .bigSecret{
    font-size:28px;font-weight:1000;letter-spacing:6px;
    padding:10px 14px;border-radius:16px;border:1px dashed var(--line2);
    display:inline-flex;align-items:center;gap:10px;
    background:transparent;
  }

  .boxes{display:flex;gap:8px;flex-wrap:wrap}
  .digitBox{
    width:54px;height:54px;border-radius:16px;border:1px solid var(--line2);
    display:flex;align-items:center;justify-content:center;
    background:transparent;
  }
  .digitBox input{
    width:100%;height:100%;
    border:0;outline:none;
    background:transparent;color:var(--ink);
    text-align:center;font-size:20px;font-weight:950;
  }

  .statusLine{font-weight:950}
  .statusLine.good{color:var(--good)}
  .statusLine.warn{color:var(--warn)}
  .statusLine.bad{color:var(--bad)}

  /* HISTORY */
  .history{max-height:360px;overflow:auto;padding-right:6px}
  .logItem{
    border:1px solid var(--line);
    background:transparent;
    border-radius:14px;
    padding:10px 10px;
    margin:8px 0;
  }
  .logTop{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:flex-end}
  .tag{font-size:11px;font-weight:950;padding:3px 8px;border-radius:999px;border:1px solid var(--line2);color:var(--muted)}
  .guess{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    font-size:18px;font-weight:950;letter-spacing:3px;
  }
  .ago{font-size:11px;color:var(--muted);margin-top:4px}

  .smallTabs{display:flex;gap:8px}
  .smallTabs button{padding:7px 10px;border-radius:12px;font-size:13px}

  /* MODALS */
  .modalBack{
    position:fixed;inset:0;background:rgba(0,0,0,.55);
    display:none;align-items:center;justify-content:center;z-index:9999;
    padding:16px;
  }
  .modalBack.show{display:flex}
  .modal{
    max-width:760px;width:100%;
    background:var(--card);border:1px solid var(--line);
    border-radius:18px;padding:16px;box-shadow:var(--shadow);
  }
  .modal h2{margin:0 0 10px;font-size:22px}
  .modal .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:12px;flex-wrap:wrap}
  .winnerName{
    font-size:28px;font-weight:1000;
    background:linear-gradient(90deg,var(--accent),var(--accent2));
    -webkit-background-clip:text;background-clip:text;color:transparent;
  }

  /* CONFETTI (new) */
  .confetti{
    position:fixed; inset:0; pointer-events:none; z-index:9998; overflow:hidden;
  }
  .confetti i{
    position:absolute; top:-20px;
    width:10px; height:14px; border-radius:3px;
    opacity:.95;
    animation:confFall linear forwards;
  }
  @keyframes confFall{
    to{
      transform: translateY(110vh) rotate(720deg);
      opacity: 1;
    }
  }
</style>
</head>

<body>
<div class="confetti" id="confetti"></div>

<!-- Rules Modal -->
<div class="modalBack" id="rulesBack">
  <div class="modal">
    <h2>How to Play ‚Äî Crack the Code</h2>
    <div class="mini" style="margin-bottom:10px">
      2 players ‚Ä¢ Same room ‚Ä¢ Turn-by-turn guessing ‚Ä¢ First to crack the opponent's code wins.
    </div>

    <div class="panel" style="margin-bottom:10px">
      <div class="title">Lobby</div>
      <ul style="margin:6px 0 0 18px">
        <li>Player A creates a room and shares the <b>Room Code</b>.</li>
        <li>Player B joins using the same code.</li>
        <li>Choose digits (3/4/5/6). If digits change, secrets reset automatically.</li>
        <li>Each player locks their own secret (example: <b>7590</b>).</li>
      </ul>
    </div>

    <div class="panel">
      <div class="title">Turns & Feedback</div>
      <ul style="margin:6px 0 0 18px">
        <li>On your turn, enter a guess with the same number of digits.</li>
        <li>Feedback shows:
          <ul>
            <li><b>X numbers correct</b> (correct digits anywhere)</li>
            <li><b>Y positions correct</b> (correct digit + correct place)</li>
          </ul>
        </li>
        <li>History stores all guesses and feedback for strategy.</li>
      </ul>
    </div>

    <div class="actions">
      <button id="closeRules" class="primary">Got it</button>
    </div>
  </div>
</div>

<!-- Winner Modal -->
<div class="modalBack" id="winnerBack">
  <div class="modal">
    <h2>üèÜ Winner</h2>
    <div class="winnerName" id="winnerName">-</div>
    <div class="mini" style="margin-top:6px">Click ‚ÄúOne more game‚Äù to return to the lobby and play again.</div>
    <div class="actions">
      <button id="winnerNext" class="primary">üîÅ One more game</button>
      <button id="winnerClose">Close</button>
    </div>
  </div>
</div>

<div class="wrap">
  <div class="card">

    <div class="topbar">
      <div class="pill" style="gap:10px">
        <span class="mini">Room</span>
        <b id="roomTop">-</b>
        <button id="copyRoom" class="iconBtn" style="padding:7px 10px;border-radius:999px">üìã Copy</button>
      </div>

      <div class="btnRow">
        <button id="rulesBtn" class="iconBtn">‚ÑπÔ∏è Rules</button>

        <select id="themeSel" class="iconBtn" style="padding:9px 12px">
          <option value="random">üé≤ Random theme</option>
          <option value="light">‚òÄÔ∏è Light</option>
          <option value="dark">üåô Dark</option>
          <option value="ocean">üåä Ocean</option>
          <option value="sunset">üåÖ Sunset</option>
          <option value="forest">üåø Forest</option>
          <option value="candy">üç¨ Candy</option>
        </select>

        <button id="themeRand" class="iconBtn primary">üé® Shuffle</button>
      </div>
    </div>

    <h1>Crack the Code</h1>

    <!-- TIP moved to first page -->
    <div class="mini" id="tipLine" style="text-align:center;margin-bottom:12px">
      Tip: If you leave name empty, default will be Player A / Player B.
    </div>

    <!-- Step: Choose -->
    <div id="step-choose" class="center" style="margin:8px 0 6px">
      <button id="btnCreate" class="primary">Create Room</button>
      <button id="btnJoin">Join Room</button>
    </div>

    <!-- Create -->
    <div id="step-create" class="hidden">
      <div class="row2">
        <div>
          <div class="title">Your Name</div>
          <input id="createName" type="text" placeholder="e.g., Player A" />
        </div>
        <div>
          <div class="title">Room Code</div>
          <input id="createCode" type="text" readonly />
        </div>
      </div>
      <div class="center" style="margin-top:10px">
        <button id="createGo" class="primary">Create & Enter Lobby</button>
        <button id="back1">Back</button>
      </div>
    </div>

    <!-- Join -->
    <div id="step-join" class="hidden">
      <div class="row2">
        <div>
          <div class="title">Your Name</div>
          <input id="joinName" type="text" placeholder="e.g., Player B" />
        </div>
        <div>
          <div class="title">Room Code</div>
          <input id="joinCode" type="text" placeholder="ABCDE" />
        </div>
      </div>
      <div class="center" style="margin-top:10px">
        <button id="joinGo" class="primary">Join Lobby</button>
        <button id="back2">Back</button>
      </div>
    </div>

    <!-- Lobby (redesigned simple) -->
    <div id="step-lobby" class="hidden">
      <div class="row2">
        <div class="panel">
          <div class="title">Players</div>
          <div class="mini" style="margin-bottom:10px">You can keep defaults or type your names.</div>

          <div class="row2">
            <div>
              <div class="mini">Player A</div>
              <input id="nameA" type="text" placeholder="Player A" />
            </div>
            <div>
              <div class="mini">Player B</div>
              <input id="nameB" type="text" placeholder="Player B" />
            </div>
          </div>

          <div class="center" style="margin-top:10px;justify-content:flex-start">
            <button id="saveNames" class="primary">Save Names</button>
          </div>

          <div class="mini" style="margin-top:10px" id="nameStatus"></div>
        </div>

        <div class="panel">
          <div class="title">Game setup</div>

          <div class="mini" style="margin-bottom:6px">Digits</div>
          <select id="digitsSel">
            <option value="3">3 digits (‚âà 5‚Äì10 min)</option>
            <option value="4" selected>4 digits (‚âà 10‚Äì20 min)</option>
            <option value="5">5 digits (‚âà 20‚Äì35 min)</option>
            <option value="6">6 digits (‚âà 35‚Äì60 min)</option>
          </select>

          <div class="mini" style="margin-top:8px" id="digitsHint">
            Changing digits will reset secrets automatically.
          </div>

          <div class="hr"></div>

          <div class="title">Set your secret</div>
          <div class="mini" style="margin-bottom:8px">
            Enter exactly <b id="digitCountLabel">4</b> digits.
          </div>
          <div class="boxes" id="secretBoxes"></div>

          <div class="center" style="margin-top:10px;justify-content:flex-start">
            <button id="setSecretBtn" class="primary">Lock Secret</button>
            <button id="clearSecretBtn">Clear</button>
          </div>

          <div class="mini" style="margin-top:10px" id="secretStatus"></div>
        </div>
      </div>

      <div class="hr"></div>
      <div class="center">
        <button id="goGameBtn" class="primary hidden">Go to Game</button>
      </div>
    </div>

    <!-- Game -->
    <div id="step-game" class="hidden">
      <div class="gameGrid">

        <!-- Left -->
        <div class="panel">
          <div class="turnBanner">
            <div class="pill">
              <span class="mini">You</span>&nbsp;<span id="youDot" class="dot"></span>&nbsp;<b id="youName">-</b>
            </div>
            <div class="pill">
              <span class="mini">Turn</span>&nbsp;<b id="turnName">-</b>
            </div>
          </div>

          <div class="hr"></div>

          <div class="title">Your secret</div>
          <div class="bigSecret">
            <span id="mySecretDisplay">‚Ä¢‚Ä¢‚Ä¢‚Ä¢</span>
            <button id="toggleSecret" class="iconBtn" style="padding:7px 10px">üëÅÔ∏è</button>
          </div>

          <div class="hr"></div>

          <div class="title">Enter your guess</div>
          <div class="mini" style="margin-bottom:8px">
            Enter <b id="guessDigitCount">4</b> digits. (Enter key submits)
          </div>

          <div class="boxes" id="guessBoxes"></div>

          <div class="center" style="margin-top:10px;justify-content:flex-start">
            <button id="submitGuess" class="primary">Submit Guess</button>
            <button id="clearGuess">Clear</button>
          </div>

          <div class="mini" style="margin-top:10px" id="lastFeedback">Waiting...</div>

          <div class="hr"></div>
          <div class="center" style="justify-content:flex-end">
            <button id="oneMoreGame" class="primary hidden">üîÅ One more game</button>
          </div>
        </div>

        <!-- Right -->
        <div class="panel">
          <div class="title">History</div>

          <div class="smallTabs" style="margin-top:8px">
            <button id="tabMine" class="primary">Mine</button>
            <button id="tabOpp">Opponent</button>
          </div>

          <div class="hr"></div>
          <div class="history" id="historyList"></div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

<script>
/* ==========================
   Firebase Config (REPLACE)
   ========================== */
const firebaseConfig = {
  apiKey: "AIzaSyDIL-Awme_yTv9Jt7tSdX2WI2BkOlbHTlI",
  authDomain: "crack-the-code-game-35615.firebaseapp.com",
  projectId: "crack-the-code-game-35615",
  storageBucket: "crack-the-code-game-35615.firebasestorage.app",
  messagingSenderId: "281951990500",
  appId: "1:281951990500:web:ab19ad486b05477e06b2f1"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ==========================
   State
   ========================== */
const THEMES = ["light","dark","ocean","sunset","forest","candy"];
const PASTEL = ["#ff6b6b","#60a5fa","#34d399","#fbbf24","#a78bfa","#22d3ee","#f472b6","#86efac"];

let my = { pid:null, name:"", color:"", room:"" };

let roomState = {
  settings:{ digits:4 },
  order: [],
  players: {},
  secrets: {},
  started: false,
  turnPid: null,
  winner: null,
  stage: "lobby",
  guessesList: []
};

let currentTab = "mine";
let revealSecret = false;
let elapsedTimer = null;

/* ==========================
   Helpers
   ========================== */
const $ = id => document.getElementById(id);
const show = id => $(id).classList.remove("hidden");
const hide = id => $(id).classList.add("hidden");

function code(){ return Math.random().toString(36).substring(2,7).toUpperCase(); }
function now(){ return Date.now(); }

function setTheme(theme){
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("ctc_theme", theme);
  $("themeSel").value = theme;
}
function pickRandomTheme(){
  return THEMES[Math.floor(Math.random()*THEMES.length)];
}
function initTheme(){
  const saved = localStorage.getItem("ctc_theme");
  const theme = saved && THEMES.includes(saved) ? saved : pickRandomTheme();
  setTheme(theme);
}
function shuffleTheme(){
  setTheme(pickRandomTheme());
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

function agoText(ts){
  const d = Math.max(0, now() - (ts||now()));
  const sec = Math.floor(d/1000);
  if(sec < 5) return "just now";
  if(sec < 60) return `${sec}s ago`;
  const min = Math.floor(sec/60);
  if(min < 60) return `${min}m ago`;
  const hr = Math.floor(min/60);
  if(hr < 24) return `${hr}h ago`;
  const day = Math.floor(hr/24);
  return `${day}d ago`;
}

function buildDigitBoxes(hostId, digits, opts={}){
  const host = $(hostId);
  host.innerHTML = "";
  const inputs = [];

  const focusFirstEmpty = () => {
    const firstEmpty = inputs.find(i => !i.value);
    (firstEmpty || inputs[0])?.focus();
  };

  for(let i=0;i<digits;i++){
    const wrap = document.createElement("div");
    wrap.className = "digitBox";
    const inp = document.createElement("input");
    inp.type = "text";
    inp.inputMode = "numeric";
    inp.autocomplete = "one-time-code";
    inp.maxLength = 1;
    inp.placeholder = "0";

    inp.addEventListener("input", () => {
      inp.value = inp.value.replace(/[^0-9]/g,"").slice(0,1);
      if(inp.value && i < digits-1) inputs[i+1].focus();

      if(opts.onChange){
        opts.onChange(getValue());
      }
    });

    inp.addEventListener("keydown", (e) => {
      if(e.key === "Backspace" && !inp.value && i>0){
        inputs[i-1].focus();
      }
      if(e.key === "Enter"){
        const v = getValue();
        if(opts.onEnter) opts.onEnter(v);
      }
    });

    wrap.appendChild(inp);
    host.appendChild(wrap);
    inputs.push(inp);
  }

  const getValue = () => inputs.map(x => x.value).join("");
  const clear = () => { inputs.forEach(i => i.value=""); focusFirstEmpty(); };

  // public api
  return {
    focus: focusFirstEmpty,
    getValue,
    clear
  };
}

function countMatches(secret, guess){
  const n = secret.length;

  let posCorrect = 0;
  for(let i=0;i<n;i++){
    if(secret[i] === guess[i]) posCorrect++;
  }

  const freqS = {};
  const freqG = {};
  for(const ch of secret){ freqS[ch] = (freqS[ch]||0)+1; }
  for(const ch of guess){  freqG[ch] = (freqG[ch]||0)+1; }

  let numCorrect = 0;
  for(const d in freqS){
    if(freqG[d]) numCorrect += Math.min(freqS[d], freqG[d]);
  }

  return { numCorrect, posCorrect };
}

function formatFeedback(numCorrect, posCorrect){
  const n = numCorrect;
  const p = posCorrect;
  const numTxt = `${n} number${n===1?"":"s"} correct`;
  const posTxt = `${p} position${p===1?"":"s"} correct`;
  return `${numTxt}, ${posTxt}`;
}

function validDigitsString(val, digits){
  return new RegExp(`^\\d{${digits}}$`).test((val||"").trim());
}

/* ==========================
   Confetti (new)
   ========================== */
function launchConfetti(){
  const c=$("confetti"); c.innerHTML="";
  const colors=["#ef4444","#f59e0b","#10b981","#3b82f6","#a855f7","#22d3ee","#f472b6","#84cc16"];
  const pieces = 220;

  for(let i=0;i<pieces;i++){
    const p=document.createElement("i");
    const w = 6 + Math.random()*8;
    const h = 8 + Math.random()*12;
    p.style.width = w+"px";
    p.style.height = h+"px";
    p.style.left = (Math.random()*100) + "vw";
    p.style.background = colors[i % colors.length];
    p.style.opacity = (0.7 + Math.random()*0.3).toFixed(2);
    p.style.borderRadius = (Math.random() < 0.3) ? "999px" : "3px";
    p.style.animationDuration = (1.7 + Math.random()*2.0) + "s";
    p.style.animationDelay = (Math.random()*0.15) + "s";
    c.appendChild(p);
  }

  setTimeout(()=>{ c.innerHTML=""; }, 3800);
}

/* ==========================
   UI Navigation
   ========================== */
function goto(step){
  ["step-choose","step-create","step-join","step-lobby","step-game"].forEach(hide);
  show(step);
}

$("btnCreate").onclick = () => { goto("step-create"); $("createCode").value = code(); };
$("btnJoin").onclick = () => goto("step-join");
$("back1").onclick = () => goto("step-choose");
$("back2").onclick = () => goto("step-choose");

$("rulesBtn").onclick = () => $("rulesBack").classList.add("show");
$("closeRules").onclick = () => $("rulesBack").classList.remove("show");
$("rulesBack").onclick = (e) => { if(e.target.id === "rulesBack") $("rulesBack").classList.remove("show"); };

$("winnerClose").onclick = () => $("winnerBack").classList.remove("show");
$("winnerBack").onclick = (e) => { if(e.target.id === "winnerBack") $("winnerBack").classList.remove("show"); };

$("themeRand").onclick = shuffleTheme;
$("themeSel").onchange = () => {
  const v = $("themeSel").value;
  if(v === "random") shuffleTheme();
  else setTheme(v);
};

$("copyRoom").onclick = async () => {
  const r = $("roomTop").textContent || "";
  if(!r || r === "-") return;
  try{
    await navigator.clipboard.writeText(r);
    $("copyRoom").textContent = "‚úÖ Copied";
    setTimeout(()=> $("copyRoom").textContent = "üìã Copy", 900);
  }catch(e){
    alert("Copy failed. Please copy manually.");
  }
};

/* ==========================
   Create / Join Room
   ========================== */
async function createOrJoin({mode, nickname, roomCode}){
  const room = roomCode.trim().toUpperCase();
  if(!room) return alert("Room code missing.");

  const roomRef = db.ref(`rooms/${room}`);
  const snap = await roomRef.get();

  if(mode === "create"){
    if(snap.exists()) return alert("Room already exists. Try a new code.");
    const pid = "p" + Date.now();
    my = { pid, name: nickname.trim() || "Player A", color: PASTEL[0], room };

    await roomRef.set({
      createdAt: now(),
      stage: "lobby",
      settings: { digits: 4 },
      order: [pid],
      turnPid: null,
      started: false,
      winner: null,
      resetAt: now()
    });

    await db.ref(`rooms/${room}/players/${pid}`).set({
      nickname: my.name,
      color: my.color,
      hasSecret: false
    });

  } else {
    if(!snap.exists()) return alert("Room not found.");
    const orderSnap = await db.ref(`rooms/${room}/order`).get();
    const order = orderSnap.val() || [];
    if(order.length >= 2) return alert("Room already has 2 players.");

    const pid = "p" + Date.now();
    const idx = order.length;
    my = { pid, name: nickname.trim() || (idx===0 ? "Player A" : "Player B"), color: PASTEL[idx%PASTEL.length], room };

    await db.ref(`rooms/${room}/order`).set([...order, pid]);
    await db.ref(`rooms/${room}/players/${pid}`).set({
      nickname: my.name,
      color: my.color,
      hasSecret: false
    });
  }

  $("roomTop").textContent = my.room;
  attachRoomListeners();
  goto("step-lobby");
}

$("createGo").onclick = () => createOrJoin({
  mode: "create",
  nickname: $("createName").value,
  roomCode: $("createCode").value
});
$("joinGo").onclick = () => createOrJoin({
  mode: "join",
  nickname: $("joinName").value,
  roomCode: $("joinCode").value
});

/* ==========================
   Lobby Setup
   ========================== */
let secretUI = null;
let guessUI = null;

function updateDigitsUI(digits){
  $("digitCountLabel").textContent = digits;
  $("guessDigitCount").textContent = digits;
  $("digitsSel").value = String(digits);

  secretUI = buildDigitBoxes("secretBoxes", digits);
  guessUI = buildDigitBoxes("guessBoxes", digits, {
    onEnter: (val) => {
      // Enter to submit on desktop / mobile keyboard enter
      if(validDigitsString(val, digits) && isMyTurn() && !roomState.winner) {
        submitGuessInternal().catch(()=>{});
      }
    }
  });

  // secret display: always hidden by default
  revealSecret = false;
  $("mySecretDisplay").textContent = "‚Ä¢".repeat(digits);
}

function lobbyStatusText(){
  const order = roomState.order || [];
  if(order.length < 2) return `<span class="statusLine warn">Waiting for second player to join...</span>`;
  const pA = roomState.players?.[order[0]];
  const pB = roomState.players?.[order[1]];
  if(!(pA?.hasSecret && pB?.hasSecret)) return `<span class="statusLine warn">Waiting until both players lock secrets...</span>`;
  return `<span class="statusLine good">Both secrets ready. Starting game‚Ä¶</span>`;
}

$("goGameBtn").onclick = () => goto("step-game");

function canStart(){
  const order = roomState.order || [];
  if(order.length !== 2) return false;
  const pA = roomState.players?.[order[0]];
  const pB = roomState.players?.[order[1]];
  return !!(pA?.hasSecret && pB?.hasSecret);
}

async function ensureStartIfReady(){
  if(roomState.started) return;
  if(canStart()){
    const order = roomState.order;
    const firstPid = order[0];
    await db.ref(`rooms/${my.room}`).update({
      started: true,
      stage: "game",
      turnPid: firstPid,
      winner: null
    });
  }
}

/* ====== DIGITS CHANGE: auto reset secrets (fix #1, #2c) ====== */
$("digitsSel").onchange = async () => {
  const digits = parseInt($("digitsSel").value, 10);
  if(!Number.isInteger(digits) || digits < 3 || digits > 6) return;

  // Always reset secrets/guesses when digits change (even if already set)
  await resetToLobby({ digits, reason: "digitsChanged" });
};

async function resetToLobby({digits, reason}){
  const base = `rooms/${my.room}`;
  const players = roomState.players || {};
  const updates = {};
  Object.keys(players).forEach(pid => {
    updates[`${base}/players/${pid}/hasSecret`] = false;
  });

  // clear secrets + guesses and mark lobby
  updates[`${base}/secrets`] = null;
  updates[`${base}/guesses`] = null;
  updates[`${base}/started`] = false;
  updates[`${base}/stage`] = "lobby";
  updates[`${base}/turnPid`] = null;
  updates[`${base}/winner`] = null;
  updates[`${base}/resetAt`] = now();
  updates[`${base}/settings/digits`] = digits ?? (roomState.settings?.digits || 4);
  updates[`${base}/lastResetReason`] = reason || "manual";

  await db.ref().update(updates);

  // local UI
  secretUI?.clear();
  guessUI?.clear();
}

/* ====== Save names (simple) ====== */
$("saveNames").onclick = async () => {
  const order = roomState.order || [];
  const aPid = order[0];
  const bPid = order[1];

  const nA = ($("nameA").value || "").trim();
  const nB = ($("nameB").value || "").trim();

  const ups = {};
  if(aPid && nA) ups[`rooms/${my.room}/players/${aPid}/nickname`] = nA;
  if(bPid && nB) ups[`rooms/${my.room}/players/${bPid}/nickname`] = nB;

  if(Object.keys(ups).length === 0){
    $("nameStatus").textContent = "Nothing to save.";
    return;
  }
  await db.ref().update(ups);
  $("nameStatus").textContent = "Names saved.";
  setTimeout(()=> $("nameStatus").textContent="", 1200);
};

/* ====== Lock secret (validation fixed) ====== */
$("setSecretBtn").onclick = async () => {
  const digits = roomState.settings?.digits || 4;
  const val = (secretUI?.getValue() || "").trim();

  if(!validDigitsString(val, digits)) return alert(`Enter exactly ${digits} digits.`);

  await db.ref(`rooms/${my.room}/secrets/${my.pid}`).set(val);
  await db.ref(`rooms/${my.room}/players/${my.pid}/hasSecret`).set(true);

  $("secretStatus").innerHTML = `<span class="statusLine good">Secret locked. Waiting for opponent‚Ä¶</span>`;
};

$("clearSecretBtn").onclick = () => secretUI?.clear();

/* ==========================
   Game Logic
   ========================== */
function myOpponentPid(){
  const order = roomState.order || [];
  if(order.length !== 2) return null;
  return order[0] === my.pid ? order[1] : order[0];
}

function isMyTurn(){
  return roomState.turnPid === my.pid;
}

function renderGameHeader(){
  const me = roomState.players?.[my.pid] || {};
  $("youName").textContent = me.nickname || my.name || "You";
  $("youDot").style.background = me.color || my.color || "#999";

  const turnPid = roomState.turnPid;
  const turnName = roomState.players?.[turnPid]?.nickname || "-";
  $("turnName").textContent = turnName;

  const digits = roomState.settings?.digits || 4;
  const mySecret = roomState.secrets?.[my.pid] || "";

  if(revealSecret && mySecret){
    $("mySecretDisplay").textContent = mySecret;
  }else{
    $("mySecretDisplay").textContent = "‚Ä¢".repeat(digits);
  }

  const disabled = !roomState.started || !!roomState.winner || !isMyTurn();
  $("submitGuess").disabled = disabled;
  $("clearGuess").disabled = disabled;

  if(roomState.winner){
    const name = roomState.winner.name || "Winner";
    $("lastFeedback").innerHTML = `<span class="statusLine good">Game ended. Winner: <b>${escapeHtml(name)}</b></span>`;
    show("oneMoreGame");
  }else{
    hide("oneMoreGame");
    if(!roomState.started){
      $("lastFeedback").innerHTML = `<span class="statusLine warn">Waiting for game to start‚Ä¶</span>`;
    } else if(isMyTurn()){
      $("lastFeedback").innerHTML = `<span class="statusLine good">Your turn. Enter a guess.</span>`;
      // Autofocus (fix #10)
      setTimeout(()=> guessUI?.focus(), 50);
    } else {
      $("lastFeedback").innerHTML = `<span class="statusLine warn">Opponent's turn‚Ä¶</span>`;
    }
  }
}

$("toggleSecret").onclick = () => { revealSecret = !revealSecret; renderGameHeader(); };

$("clearGuess").onclick = () => guessUI?.clear();

async function submitGuessInternal(){
  if(!isMyTurn()) return alert("Not your turn.");
  if(roomState.winner) return;

  const digits = roomState.settings?.digits || 4;
  const guess = (guessUI?.getValue() || "").trim();

  if(!validDigitsString(guess, digits)) return alert(`Enter exactly ${digits} digits.`);

  const oppPid = myOpponentPid();
  const oppSecret = roomState.secrets?.[oppPid];
  if(!oppSecret) return alert("Opponent secret not ready.");

  const { numCorrect, posCorrect } = countMatches(oppSecret, guess);
  const feedback = formatFeedback(numCorrect, posCorrect);

  const gRef = db.ref(`rooms/${my.room}/guesses`).push();
  await gRef.set({
    by: my.pid,
    guess,
    numCorrect,
    posCorrect,
    feedback,
    ts: now()
  });

  if(guess === oppSecret){
    const winnerName = roomState.players?.[my.pid]?.nickname || my.name || "Winner";
    await db.ref(`rooms/${my.room}/winner`).set({ pid: my.pid, name: winnerName, at: now() });
    return;
  }

  await db.ref(`rooms/${my.room}/turnPid`).set(oppPid);
  guessUI?.clear();
}

$("submitGuess").onclick = () => submitGuessInternal().catch(()=>{});

/* Next game button: resets for BOTH players (fix #5) */
$("oneMoreGame").onclick = async () => {
  const digits = roomState.settings?.digits || 4;
  await resetToLobby({ digits, reason: "nextGame" });
};

$("winnerNext").onclick = async () => {
  $("winnerBack").classList.remove("show");
  const digits = roomState.settings?.digits || 4;
  await resetToLobby({ digits, reason: "winnerNext" });
};

/* ==========================
   History
   ========================== */
$("tabMine").onclick = () => {
  currentTab = "mine";
  $("tabMine").classList.add("primary");
  $("tabOpp").classList.remove("primary");
  renderHistory();
};
$("tabOpp").onclick  = () => {
  currentTab = "opp";
  $("tabOpp").classList.add("primary");
  $("tabMine").classList.remove("primary");
  renderHistory();
};

function renderHistory(){
  const host = $("historyList");
  host.innerHTML = "";

  const guesses = roomState.guessesList || [];
  const oppPid = myOpponentPid();

  const filtered = guesses.filter(g => currentTab === "mine" ? g.by === my.pid : g.by === oppPid);

  if(filtered.length === 0){
    host.innerHTML = `<div class="mini">No guesses yet.</div>`;
    return;
  }

  filtered.slice().reverse().forEach(g => {
    const byName = roomState.players?.[g.by]?.nickname || "Player";
    const item = document.createElement("div");
    item.className = "logItem";
    item.innerHTML = `
      <div class="logTop">
        <div><span class="tag">${escapeHtml(byName)}</span></div>
        <div class="guess">${escapeHtml(g.guess)}</div>
      </div>
      <div class="mini" style="margin-top:6px">${escapeHtml(g.feedback)}</div>
      <div class="ago" data-ts="${g.ts||0}">${agoText(g.ts||0)}</div>
    `;
    host.appendChild(item);
  });
}

function startElapsedUpdater(){
  if(elapsedTimer) return;
  elapsedTimer = setInterval(()=>{
    document.querySelectorAll("[data-ts]").forEach(el => {
      const ts = parseInt(el.getAttribute("data-ts"), 10) || 0;
      el.textContent = agoText(ts);
    });
  }, 5000);
}

/* ==========================
   Room listeners
   ========================== */
let roomUnsubs = [];

function detachRoomListeners(){
  roomUnsubs.forEach(fn => fn && fn());
  roomUnsubs = [];
}

function attachRoomListeners(){
  detachRoomListeners();

  const base = `rooms/${my.room}`;

  const on = (path, cb) => {
    const ref = db.ref(path);
    ref.on("value", cb);
    roomUnsubs.push(() => ref.off("value", cb));
  };

  on(`${base}`, (snap) => {
    const v = snap.val();
    if(!v) return;

    roomState.settings = v.settings || {digits:4};
    roomState.order = v.order || [];
    roomState.started = !!v.started;
    roomState.turnPid = v.turnPid || null;
    roomState.winner = v.winner || null;
    roomState.stage = v.stage || "lobby";

    $("roomTop").textContent = my.room;

    // reflect names in lobby inputs (not overwriting what user is typing if focused)
    const order = roomState.order || [];
    const aPid = order[0];
    const bPid = order[1];
    if(document.activeElement !== $("nameA")){
      $("nameA").value = roomState.players?.[aPid]?.nickname || "";
    }
    if(document.activeElement !== $("nameB")){
      $("nameB").value = roomState.players?.[bPid]?.nickname || "";
    }

    const digits = roomState.settings.digits || 4;
    updateDigitsUI(digits);

    // route
    if(roomState.stage === "game") goto("step-game");
    else goto("step-lobby");

    $("secretStatus").innerHTML = lobbyStatusText();

    // show go-to-game if started but still in lobby stage (rare)
    if(roomState.stage === "lobby" && roomState.started) show("goGameBtn");
    else hide("goGameBtn");

    ensureStartIfReady().catch(()=>{});
    renderGameHeader();
    renderHistory();
    startElapsedUpdater();
  });

  on(`${base}/players`, (snap) => {
    roomState.players = snap.val() || {};
    $("secretStatus").innerHTML = lobbyStatusText();
    ensureStartIfReady().catch(()=>{});
    renderGameHeader();
  });

  on(`${base}/secrets`, (snap) => {
    roomState.secrets = snap.val() || {};
    $("secretStatus").innerHTML = lobbyStatusText();
    ensureStartIfReady().catch(()=>{});
    renderGameHeader();
  });

  on(`${base}/guesses`, (snap) => {
    const obj = snap.val() || {};
    const list = Object.entries(obj).map(([id, g]) => ({ id, ...g }));
    list.sort((a,b) => (a.ts||0) - (b.ts||0));
    roomState.guessesList = list;
    renderHistory();
  });

  on(`${base}/winner`, (snap) => {
    const w = snap.val();
    roomState.winner = w || null;

    if(w && w.name){
      // Winner popup (fix #4)
      $("winnerName").textContent = w.name;
      $("winnerBack").classList.add("show");
      launchConfetti();
    }
    renderGameHeader();
  });
}

/* ==========================
   Boot
   ========================== */
initTheme();
goto("step-choose");

// Better mobile UX: if user taps anywhere in guess area, focus first empty box
document.addEventListener("click", (e) => {
  if(e.target.closest("#guessBoxes") && roomState.stage === "game" && isMyTurn() && !roomState.winner){
    guessUI?.focus();
  }
});

// Basic cleanup: remove player on tab close (best-effort)
window.addEventListener("beforeunload", () => {
  try{
    if(my?.room && my?.pid){
      db.ref(`rooms/${my.room}/players/${my.pid}`).remove();
    }
  }catch(e){}
});
</script>

</body>
</html>
